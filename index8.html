<!DOCTYPE html>
<html>
  <head></head>
  <body>

<!-- --------------------------------------------------- -->
<h1>A Dashboard in the browser using Plotly and/or Pyodide: plot data from a csv file</h1>
	  
<br><br>
    
<!-- View two split window -->
<div align="left">
<table style='text-align: left; width: 300px; display:block'>
<tr>
        
<td>
<label id="get_downloadurl_label" style="display:block">[Step 0] (Optional) Obtain the download url for a file in a GitHub repository. Enter the desired repository Owner, repository Name, csv filename (ie: CodeSolutions2, plotly_pyodide_dashboard, data.csv).</label>
<!-- CodeSolutions2, plotly_pyodide_dashboard, data.csv -->
<br><br>
<input id="repoOwner" type="text" value="" placeholder="repoOwner" rows="10" cols="100" style="display:block; text-align: left; width: 200px;">
<input id="repoName" type="text" value="" placeholder="repoName" rows="10" cols="100" style="display:block; text-align: left; width: 200px;">
<input id="csv_filename" type="text" value="" placeholder="csv_filename" rows="10" cols="100" style="display:block; text-align: left; width: 200px;">
<br>
<button id="get_download_url_button" onclick="GET_text_from_file_wo_auth_GitHub_RESTAPI()">Get a download url for a file</button>

<br><br>
	  
<label id="enter_url_label" style="display:block">[Step 1] Enter a url of a csv file to present the data in a table</label>
<br><br>
<!-- https://raw.githubusercontent.com/CodeSolutions2/plotly_pyodide_dashboard/main/data.csv -->
<input id="csv_dataset_url" type="text" value="" placeholder="csv_dataset_url" rows="10" cols="100" style="display:block; text-align: left; width: 550px;">
<br><br>
<!--Radio button : https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/radio-->
<!-- Giving all the buttons the same name allows one radio button to be checked at a time-->
<fieldset>
<legend>Select a backend computational engine:</legend>
<div><input type="radio" id="python_pyodide" name="radio_name" value="python_pyodide" /><label for="python_pyodide">TESTpython_pyodide</label></div>
<div><input type="radio" id="javascript" name="radio_name" value="javascript" /><label for="javascript">javascript</label></div>
</fieldset>
<br>
<button id="show_data" onclick="show_selected_csv_data()">Show selected csv data</button>

<br><br>

<label id="transform_plot_label" style="display:block">[Step 2] Decide how to visualize the data in the table</label>
<br>
<button id="bar_chart_arrayInputOnly" onclick="bar_chart_arrayInputOnly()" style="display:block">Bar chart of an accumulated/counted value column</button>
<button id="line_chart_arrayInputOnly" onclick="line_chart_arrayInputOnly()" style="display:block">Line chart of a column</button>
</td>

<!-- View results -->
<td id="graph_output">	
<!-- <textarea id="graph_output" rows="35" cols="100" placeholder="" style="display:block"></textarea> -->
<label id="modify_plots" style="display:block">[Step 3] (Optional) Make a new {'labels': ['c', 'a', 'b', 'd', 'f', 'g'], 'values': ['2', '1', '1', '1', '1', '1']} using the DataFrame data to submit to a plot.</label>
<input id="python_input" type="text" value="" placeholder="Python backend" rows="10" cols="100" style="display:block; text-align: left; height: 100px; width: 500px;">
<br>
<input id="javascript_input" type="text" value="" placeholder="JavaScript backend" rows="10" cols="100" style="display:block; text-align: left; height: 100px; width: 500px;">
<br>
<div id="output" style="font-family:courier;font-size:24px;height:300px"></div>
<br>
<div id="js_plot_bar" style="width:600px;height:250px;"></div>
<br><br>
<div id="js_plot_line" style="width:600px;height:250px;"></div>
</td>
        
</tr>
</table>
</div>  

<!-- --------------------------------------------------- -->

<!-- CSS -->
<style>
div {position: relative; z-index: 0;}
table {border-collapse: collapse; position: relative; z-index: 0;}
td {vertical-align: top;}
th {border: 0px solid black; padding: 10px 20px;}
td#dynamic_table {border: 1px solid black; padding: 10px 20px;}
input#python_input {background-color: #b8c0d6;border: 0.5px grey;-webkit-border-radius: 5px;-moz-border-radius: 5px;border-radius: 5px;}
input#javascript_input {background-color: #7fb88e;border: 0.5px grey;-webkit-border-radius: 5px;-moz-border-radius: 5px;border-radius: 5px;}
</style>
	  
<!-- --------------------------------------------------- -->


<script src="https://cdn.jsdelivr.net/pyodide/dev/full/pyodide.js"></script>
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js" charset="utf-8"></script>

	  
<script>
const outp = document.getElementById('output');


// ----------------------------------------------------

async function load_pyodide() {
	// -----------------------
	// const pyodideUrl = 'https://cdn.jsdelivr.net/pyodide/dev/full/';
	// let pyodide = await loadPyodide({'indexURL': pyodideUrl});
	// OR
	let pyodide = await loadPyodide(); // more robust when browser loads quickly
	// -----------------------
	
        await pyodide.loadPackage(["pandas"]);
	
        return pyodide;
}

// var pyodideReadyPromise = load_pyodide();

	
// ----------------------------------------------------

// Step 0
async function GET_text_from_file_wo_auth_GitHub_RESTAPI() {
	
	const repoOwner = document.getElementById("repoOwner").value;
	const repoName = document.getElementById("repoName").value;
	const csv_filename = document.getElementById("csv_filename").value;
	
	var url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents`;

	var file_objects = [];
	return await fetch(url)
		.then(res => res.json())
		.then(data => { data.forEach(async function(file) {
			    var regexp = new RegExp(`${csv_filename}`, 'g');
		      if (file.type === 'file' && file.name.match(regexp)) {
			      file_objects.push(file); 
			      outp.innerHTML = file.download_url;
			      // document.getElementById("enter_url_label").value = file.download_url;
			      // document.getElementById("enter_url_label").setAttribute("value", file.download_url);
			      // console.log('file.download_url: ', file.download_url);
			      
		      }
		      });
		      return file_objects;
		})
		.catch(error => { console.log(error); });
}

// ----------------------------------------------------

// Step 1
async function show_selected_csv_data() {

	const csv_dataset_url = document.getElementById("csv_dataset_url").value;
	const python_pyodide = document.getElementById("python_pyodide").checked;
	const javascript = document.getElementById("javascript").checked;

	if (python_pyodide == true && javascript == false) {
		// python_pyodide
		// await python_load_data(csv_dataset_url);
		await test_python_function();
	}
	if (python_pyodide == false && javascript == true) {
		// javascript
		await javascript_load_data(csv_dataset_url);
	}
	
}


	
async function python_load_data(csv_dataset_url) {

	var pyodide = await pyodideReadyPromise;

       try {
	       let result = await pyodide.runPython("from pyodide.http import open_url; import pandas as pd; url_content = open_url("+`"${csv_dataset_url}"`+"); df = pd.read_csv(url_content); df.to_json(orient='split')");
	       // {"columns":["a"],"index":[0,1,2,3,4,5,6],"data":[["a"],["b"],["c"],["c"],["f"],["d"],["g"]]}
	       
	       await output_results_load_data(result);
       } catch (error){ 
	       console.log('error: ', error);
       }
}


async function output_results_load_data(result) {

	// Display on page
	// outp.innerHTML = result;
	
	await convert_dictionarylikestring_to_dictionary(result)
		.then(async function(dictc) {
			delete dictc.columns;
			console.log('dictc: ', dictc);
			return await dictionary_to_array(dictc);
		})
		.then(async function(rowArray) {
			await generateTable_dynamically_by_row(rowArray);
		})
		.catch(error => { console.log(error); });
}

	
async function test_python_function() {
	var result = '{"columns":["a"],"index":[0,1,2,3,4,5,6],"data":[["a"],["b"],["c"],["c"],["f"],["d"],["g"]]}';

	await convert_dictionarylikestring_to_dictionary(result)
		.then(async function(dictc) {
			delete dictc.columns;
			console.log('dictc: ', dictc);
			return await dictionary_to_array(dictc);
		})
		.then(async function(rowArray) {
			await generateTable_dynamically_by_row(rowArray);
		})
		.catch(error => { console.log(error); });
	
}
// ----------------------------------------------------
	
async function javascript_load_data(csv_dataset_url) {

  // Read data into Javascript from .csv
  return await GET_text_from_file_wo_auth_GitHub_RESTAPI_directurl(csv_dataset_url)
	  .then(async function(text_out) { 
		  var arr = text_out.split('\n');
		  
		  // Plot in table
		  await generateTable_dynamically_by_row(arr);
	  })
	  .catch(error => { console.log(error); });
  
}




// ----------------------------------------------------

// Step 2: decide how to visualize the data in the table
// Make buttons appear that can format (ie: value_counts/counter) and plot the data

async function bar_chart_arrayInputOnly() {

	// Read array data from the page
	let arr_string = outp.innerHTML;

	// Select the column that one wants to make a bar chart of

	let arr = arr_string.split(',');
	
	return await counter(arr)
		.then(async function(dictc) { await bar_chart(dictc); });
}

async function line_chart_arrayInputOnly() {

	// Read array data from the page
	let arr_string = outp.innerHTML;

	// Select the column that one wants to make a bar chart of

	let arr = arr_string.split(',');
	
	return await line_chart(arr);
}
	
	
// ----------------------------------------------------
// SUBFUNCTIONS
// ----------------------------------------------------

async function bar_chart(dictc) {
	// https://plotly.com/javascript/bar-charts/
	var xValue = dictc.labels;
	var yValue = dictc.values;
	var trace1 = { x: xValue, y: yValue, type: 'bar', text: yValue.map(String), textposition: 'auto', hoverinfo: 'none', marker: { color: 'rgb(158,202,225)', opacity: 0.6, line: {color: 'rgb(8,48,107)', width: 1.5} } };
	var data = [trace1];
	var layout = { title: 'Bar chart', barmode: 'stack', xaxis: {title: 'index'}, yaxis: {title: 'count'} };
	Plotly.newPlot('js_plot_bar', data, layout);
}

// ----------------------------------------------------

async function line_chart(arr) {
        // https://plotly.com/javascript/getting-started/
        const index = [...Array(arr.length).keys()].map((x) => x);
        const trace_items = { x: index, y: arr, mode: 'markers', type: 'line' };
        const layout = {title: 'Line and Scatter Plot', xaxis: {title: 'index'}, yaxis: {title: 'count'} };
        Plotly.newPlot("js_plot_line", [trace_items], layout );
}

// ----------------------------------------------------
	
async function counter(arr) {
	// Returns the unique values in vec, which a count of how many times the value appears
	let unique = [...new Set(arr)];
	// console.log('unique: ', unique);
	let truevals = (num) => num.length > 0;
	const unique1 = unique.filter(truevals);
	truevals = (num) => num != "\n";
	const unique2 = unique1.filter(truevals);
	// console.log('unique2: ', unique2);
	
	let count = [];
	unique2.forEach(async function(val, index) {
		const uq_vals = (num) => num === val;
		const uq_val_arr = arr.filter(uq_vals);
		// console.log('val: ', val, 'uq_val_arr: ', uq_val_arr);
		count.push(uq_val_arr.length);
	});
	
	// Create a dictionary
	return {labels: unique, values: count};
}

// ----------------------------------------------------

async function convert_dictionarylikestring_to_dictionary(dictc_string) {

	// Transforms a dictionary string like the following: {'labels': ['c', 'a', 'b', 'd', 'f', 'g'], 'values': ['2', '1', '1', '1', '1', '1']}, into a JavaScript dictionary.

	const NoDoublequote = (num) => num != '"'
	const Noquote = (num) => num != "'"
	const Nospace = (num) => num != " "

	// -----------------------
	
	// Ensure the input is a string
	dictc_string = dictc_string.toString();
	console.log('dictc_string: ', dictc_string);
	console.log('dictc_string.length: ', dictc_string.length);

	// -----------------------
	
	let char_arr = dictc_string.split('');

	// Remove all blank spaces from the char array
	char_arr = char_arr.filter(Nospace);
	
	let char_arr_orglen = char_arr.length;

	// -----------------------
	
	// Design 2: without relying on JSON.parse
	let flag = 'not_done';
	let array0 = [];
	let array1 = [];
	let c = 0;
	
	while (flag == 'not_done') {

		console.log('char_arr: ', char_arr);
		
		// there are 3 unique characters to search for each loop
		// : - indicates end of key
		// [ - indicates start of array
		// ] - indicates end of array OR ]," (for pandas split notation to avoid cutting rows in square brackets)
		let uq0 = char_arr.findIndex((char) => char == ':');
		console.log('uq0: ', uq0);
		
		let uq1 = char_arr.findIndex((char) => char == '[');
		console.log('uq1: ', uq1);

		// -----------------------
		// For simplistic dictionary string: {'labels': ['c', 'a', 'b', 'd', 'f', 'g'], 'values': ['2', '1', '1', '1', '1', '1']}
		let uq2 = char_arr.findIndex((char) => char == ']');  // end marker
		console.log('uq2: ', uq2);

		// For complex dictionary string: {"columns":["a"],"index":[0,1,2,3,4,5,6],"data":[["a"],["b"],["c"],["c"],["f"],["d"],["g"]]}

		// Idea (Confirm that the end marker is correct - the end marker needs to have a sequential pattern of ],' or ]," ): search (from left to right) for current : and the next : to the right

		// step 0: obtain string from after the current : to the end of string
		let next_char_arr = char_arr.slice(uq1, char_arr_orglen);
		console.log('next_char_arr: ', next_char_arr);

		// step 1: find the index of the next : with respect to next_char_arr
		let uq3_1stcolonstart = next_char_arr.findIndex((char) => char == ':');
		console.log('uq3_1stcolonstart: ', uq3_1stcolonstart);
		if (uq3_1stcolonstart == 'undefined' || uq3_1stcolonstart < 0 ){ 
			// The string is at the last object value
			uq2 = char_arr.length-2;  // -2 is for removing ]} at the end
		} else {
			let uq3 = uq1 + uq3_1stcolonstart;  // index of 2nd colon to the right of the 1st colon
	
			// step 2: confirm which index is where the sequence pattern occurs
			console.log('Search increments (uq3-uq2)-3: ', (uq3-uq2)-3);
			
			// create an index array of what part of char_arr to look at for the [sequence pattern of 3 characters ( ],' OR ]," )]
			let ind = [...Array((uq3-uq2)-3).keys()].map((x) => x+uq2); // index array from uq2 to uq3 values
			let correct_index = ind.map((i) => {
				if ( [char_arr[i]+char_arr[i+1]+char_arr[i+2]].includes('],"') == true || [char_arr[i]+char_arr[i+1]+char_arr[i+2]].includes("],'") == true ) {
					console.log('sequence found map: ', char_arr[i]+char_arr[i+1]+char_arr[i+2]);
					uq2 = i;
				}
			});
			console.log('uq2 corrected: ', uq2);
		}
		
		// -----------------------

		// Obtain the key information as a string 
		let key = char_arr.slice(1, uq0);
		key = key.filter(NoDoublequote);
		key = key.filter(Noquote);
		key = key.filter(Nospace);
		key = key.join('');

		array0.push(key);
		
		// -----------------------
		
		// Obtain the value information as an array
		let char_arr_values = char_arr.slice(uq1+1, uq2);
		char_arr_values = char_arr_values.filter(Noquote);
		char_arr_values = char_arr_values.filter(Nospace);
		
		let string_values = char_arr_values.join('');
		let arr = string_values.split(',');

		// Ensure that array values are proper string or integer/float
		let object1 = {};
		arr = arr.map((num) => { object1[Number(num)] = Number(num); return object1[num] ?? num.toString(); })
		// console.log('object1: ', object1);
		// console.log('arr: ', arr);
		
		array1.push(arr);
		
		// -----------------------
		
		// Reassign char_arr to remaining string to parse
		char_arr = char_arr.slice(uq2+1, char_arr_orglen)

		// -----------------------
		
		if (char_arr.length < 3 || c > 10) { flag = 'done'; }

		c = c + 1; // to force loop to stop while debugging
		// -----------------------
	}
	
	return Object.fromEntries(array0.map((key, index) => [key, array1[index]]));
}

// ----------------------------------------------------

async function GET_text_from_file_wo_auth_GitHub_RESTAPI_directurl(file_download_url) {

	return await fetch(file_download_url)
		.then(res => res.text())
		.then(data => { 
			console.log('data: ', data); return data;
		})
		.catch(error => { console.log(error); });
}


// ----------------------------------------------------
	
async function dictionary_to_array(dictt) {

	// {'labels': ['c', 'a', 'b', 'd', 'f', 'g'], 'values': [2, 1, 1, 1, 1, 1]}
	
	var columnArray = [];
	[dictt].forEach(async function(rowdata, ind) { 
		let col = [];
		let key = Object.keys(rowdata);
		console.log('key: ', key);
		
		col.push(key);

		console.log('dictt[key]: ', dictt[key]);
		
		dictt[key].forEach(async function(val, ind) {
			col.push(val);
		});
		columnArray.push(col);
	});

	var rowArray = await transform_columnArray_into_rowArray(columnArray);
	return rowArray;
}
	
// ----------------------------------------------------

async function transform_columnArray_into_rowArray(columnArray) {

	let num_of_rows = columnArray[0].length;
	let num_of_cols = columnArray.length;

	var rowArray = [];
	for (let r=0; r < num_of_rows.length; r++){
		let row = [];
		for (let c=0; c < num_of_cols.length; c++){
			row.push(columnArray[c][r]);
		}
		rowArray.push(row);
	}
	return rowArray;
}

// -------------------------------------------------

async function generateTable_dynamically_by_row(arr) {

	// Display on page for later retrival
	outp.innerHTML = arr;
	
	const tbl = document.createElement("table");
	const tblBody = document.createElement("tbody");

	// Create row cells dynamically
	for (let i=0; i < arr.length; i++){
		// create a table row
		const row = document.createElement("tr");

		for (let j=0; j < arr[0].length; j++){
			const cell = document.createElement("td");
			cell.setAttribute("id", 'dynamic_table');
			
			const cellText = document.createTextNode(`${arr[i][j]}`);
			cell.appendChild(cellText);
			row.appendChild(cell);
		}

		// add a row to the end of the table
		tblBody.appendChild(row);
	}
	tbl.appendChild(tblBody);

	document.getElementById("graph_output").appendChild(tbl);
  }  

	
// ----------------------------------------------------


</script>


  </body>
</html>
