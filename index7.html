<!DOCTYPE html>
<html>
  <head></head>
  <body>


<script src="https://cdn.jsdelivr.net/pyodide/dev/full/pyodide.js"></script>
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js" charset="utf-8"></script>

	
<!-- --------------------------------------------------- -->

<!-- CSS -->
<style>
div {position: relative; z-index: 2;},
</style>

	  
<!-- --------------------------------------------------- -->
	  

<label id="directions" style="display:block">A Dashboard in the browser using Plotly and/or Pyodide: plot data from a csv file</label>
<br><br>
<button id="python_dashboard" onclick="python_dashboard()">python_dashboard</button>
<br><br>
<button id="python_output_to_javascript" onclick="python_output_to_javascript()">python_output_to_javascript</button>
<br><br>
<button id="javascript_dashboard" onclick="javascript_dashboard()">javascript_dashboard</button>


<!-- --------------------------------------------------- -->


<!-- View text results -->
<div id="output" style="font-family:courier;font-size:24px;height:300px"></div>


<!-- --------------------------------------------------- -->

<!-- View figure results -->
<div id="js_plot_bar" style="width:600px;height:250px;"></div>
<br><br>
<div id="js_plot_line" style="width:600px;height:250px;"></div>

<!-- --------------------------------------------------- -->


<!-- --------------------------------------------------- -->

<!-- CSS -->
<style>
div {position: relative; z-index: 0;}
</style>
	  
<!-- --------------------------------------------------- -->
	  
<script>
const outp = document.getElementById('output');

const repoOwner = 'CodeSolutions2';
const repoName = 'plotly_pyodide_dashboard';
const csv_filename = 'data.csv';

// ----------------------------------------------------

async function load_pyodide() {
	// -----------------------
	// const pyodideUrl = 'https://cdn.jsdelivr.net/pyodide/dev/full/';
	// let pyodide = await loadPyodide({'indexURL': pyodideUrl});
	// OR
	let pyodide = await loadPyodide(); // more robust when browser loads quickly
	// -----------------------
	
        await pyodide.loadPackage(["pandas"]);
        // await pyodide.loadPackage(["matplotlib"]);
	// await pyodide.loadPackage(["micropip"]);
	
        return pyodide;
}

// -----------------------

var pyodideReadyPromise = load_pyodide();

// -----------------------

async function python_output_to_javascript() {

  var dictc_string = "{'labels': ['c', 'a', 'b', 'd', 'f', 'g'], 'values': [2, 1, 1, 1, 1, 1]}";
  
  var dictc = await convert_dictionarylikestring_to_dictionary(dictc_string);

  await bar_chart(dictc);
}

// -----------------------

async function convert_dictionarylikestring_to_dictionary(dictc_string) {

	let char_arr = dictc_string.split('');
	console.log('char_arr: ', char_arr);
	
	let char_arr_orglen = char_arr.length;
	
	// Design 2: without relying on JSON.parse
	let flag = 'not_done';
	let array0 = [];
	let array1 = [];
	
	while (flag == 'not_done') {
		
		// there are 3 unique characters to search for each loop
		// : - indicates end of key
		// [ - indicates start of array
		// ] - indicates end of array
		let uq0 = char_arr.findIndex((char) => char == ':');
		let uq1 = char_arr.findIndex((char) => char == '[');
		let uq2 = char_arr.findIndex((char) => char == ']');

		// Obtain the key information as a string 
		let key = char_arr.slice(1, uq0);
		console.log('key: ', key);
		
		const isNotquote = (num) => num != "'"
		key = key.filter(isNotquote);
		console.log('key: ', key);
		
		const isNotspace = (num) => num != " "
		key = key.filter(isNotspace);
		console.log('key: ', key);
		
		key = key.join('');
		console.log('key: ', key, 'key.length: ', key.length);

		array0.push(key);
		
		// -----------------------
		
		// Obtain the value information as an array
		let char_arr_values = char_arr.slice(uq1+1, uq2);
		console.log('char_arr_values: ', char_arr_values);

		char_arr_values = char_arr_values.filter(isNotquote);
		char_arr_values = char_arr_values.filter(isNotspace);
		console.log('char_arr_values: ', char_arr_values);

		let string_values = char_arr_values.join('');
		console.log('string_values: ', string_values);
		
		let arr = string_values.split(',');
		console.log('arr: ', arr);

		// Ensure that array values are proper string or integer/float
		let object1 = {};
		arr = arr.map((num) => { object1[Number(num)] = Number(num); return object1[num] ?? num.toString(); })
		console.log('object1: ', object1);
		console.log('arr: ', arr);
		
		array1.push(arr);
		
		// -----------------------
		
		// Reassign char_arr to remaining string to parse
		char_arr = char_arr.slice(uq2+1, char_arr_orglen)
		console.log('char_arr: ', char_arr);

		// -----------------------
		
		if (char_arr.length < 3) {
			flag = 'done';
		}

		// -----------------------
	}

	const dictt = Object.fromEntries(array0.map((key, index) => [key, array1[index]]));
	console.log('dictt: ', dictt);
	return dictt;
}

// -----------------------
	
async function output_results(dictc_string) {

	let dictc_string = dictc_string.toString();
	console.log('dictc_string: ', dictc_string);
	console.log('dictc_string.length: ', dictc_string.length);
	
	outp.innerHTML = dictc_string;
	// {'labels': ['c', 'a', 'b', 'd', 'f', 'g'], 'values': ['2', '1', '1', '1', '1', '1']}
	
	await convert_dictionarylikestring_to_dictionary(dictc_string)
		.then(async function(dictc) {
			await bar_chart(dictc);
		})

}
	
// -----------------------
	
async function python_dashboard() {

	var pyodide = await pyodideReadyPromise;

	return await GET_text_from_file_wo_auth_GitHub_RESTAPI()
           .then(async function(file_objects) { 
               try {
		       let result = await pyodide.runPython("from pyodide.http import open_url; import pandas as pd; url_content = open_url("+`"${file_objects.at(0).download_url}"`+"); df = pd.read_csv(url_content); x = [i[0] for i in list(df.value_counts().index)]; y = list(df.value_counts().to_numpy()); {'labels': x, 'values': y}");
		       // {'label': ['c', 'a', 'b', 'd', 'f', 'g'], 'values': [2, 1, 1, 1, 1, 1]}
		       
		       await output_results(result);
               } catch (error){ 
		       console.log('error: ', error);
	       }
           })
           .catch(error => { console.log(error); });
}

// ----------------------------------------------------
	
async function javascript_dashboard() {

  // Read data into Javascript from .csv
  return await GET_text_from_file_wo_auth_GitHub_RESTAPI()
    .then(async function(file_objects) {
        var file_object = file_objects.at(0);
        var text_out = await fetch(file_object.download_url); return text_out
    })
    .then(response => response.text())
    .then(async function(text_out) { 
        var df_arr = text_out.split('\n');
        return await counter(df_arr);
    })
    .then(async function(dictc) { await bar_chart(dictc); return dictc; })
    .then(async function(dictc) { await line_chart(dictc); })
    .catch(error => { console.log(error); });
  
}
	
async function bar_chart(dictc) {
	// https://plotly.com/javascript/bar-charts/
	var xValue = dictc.labels;
	var yValue = dictc.values;
	var trace1 = { x: xValue, y: yValue, type: 'bar', text: yValue.map(String), textposition: 'auto', hoverinfo: 'none', marker: { color: 'rgb(158,202,225)', opacity: 0.6, line: {color: 'rgb(8,48,107)', width: 1.5} } };
	var data = [trace1];
	var layout = { title: 'Bar chart', barmode: 'stack', xaxis: {title: 'index'}, yaxis: {title: 'count'} };
	Plotly.newPlot('js_plot_bar', data, layout);
}

async function line_chart(dictc) {
        // https://plotly.com/javascript/getting-started/
        const index = [...Array(dictc.values.length).keys()].map((x) => x);
        const trace_items = { x: index, y: dictc.values, mode: 'markers', type: 'line' };
        const layout = {title: 'Line and Scatter Plot', xaxis: {title: 'index'}, yaxis: {title: 'count'} };
        Plotly.newPlot("js_plot_line", [trace_items], layout );
}

async function counter(arr) {
	// Returns the unique values in vec, which a count of how many times the value appears
	let unique = [...new Set(arr)];
	// console.log('unique: ', unique);
	let truevals = (num) => num.length > 0;
	const unique1 = unique.filter(truevals);
	truevals = (num) => num != "\n";
	const unique2 = unique1.filter(truevals);
	// console.log('unique2: ', unique2);
	
	let count = [];
	unique2.forEach(async function(val, index) {
		const uq_vals = (num) => num === val;
		const uq_val_arr = arr.filter(uq_vals);
		// console.log('val: ', val, 'uq_val_arr: ', uq_val_arr);
		count.push(uq_val_arr.length);
	});
	
	// Create a dictionary
	return {labels: unique, values: count};
}

	
// ----------------------------------------------------

	
async function GET_text_from_file_wo_auth_GitHub_RESTAPI() {
	
	var url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents`;

	var file_objects = [];
	return await fetch(url)
		.then(res => res.json())
		.then(data => { data.forEach(async function(file) {
			    var regexp = new RegExp(`${csv_filename}`, 'g');
		      if (file.type === 'file' && file.name.match(regexp)) {
            file_objects.push(file);
		      }
		    });
		    return file_objects;
		})
		.catch(error => { console.log(error); });
}

	
// ----------------------------------------------------


</script>


  </body>
</html>
